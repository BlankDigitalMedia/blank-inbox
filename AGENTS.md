# AGENTS.md - Blank Inbox Project

## Build/Lint/Test Commands
- `npm run dev` - Start Next.js development server (uses Turbopack by default in Next.js 16)
- `npm run build` - Build for production (uses Turbopack by default in Next.js 16)
- `npm run start` - Start production server
- `npm run lint` - Run ESLint (Next.js 16 removed `next lint`, use ESLint directly)
- No test commands configured yet

## Architecture
- **Frontend**: Next.js 16 + React 19 + TypeScript with App Router
  - Migrated from Next.js 15 to 16 (December 2024)
  - Turbopack is default bundler (faster builds and dev server)
  - Proxy.ts replaces middleware.ts for route protection
  - All pages are client components using Convex hooks (no server components with async request APIs)
- **Backend**: Convex (serverless functions + database)
  - Convex TypeScript configuration (`convex/tsconfig.json`) includes path aliases (`@/*` → `../*`) to resolve shared lib imports from parent directory
  - Pagination: Cursor-based pagination via Convex `paginate()` API for contact email queries (`getContactEmails`), returns 50 items per page with `continueCursor` for infinite scroll
- **UI**: shadcn/ui components with Radix UI primitives + Tailwind CSS + Sonner for toast notifications + next-themes for dark/light mode
- **Authentication**: Convex Auth with password-based authentication, single-user restriction (only first signup allowed), optional admin email restriction
  - Route protection via `proxy.ts` (Next.js 16+ convention, migrated from middleware.ts)
  - 30-day persistent cookie sessions configured in proxy
  - Server-side enforcement: `afterUserCreatedOrUpdated` callback prevents multiple signups, `profile` function validates admin email
  - All Convex queries/mutations/actions properly await `requireUserId()` for auth enforcement
- **Email**: Dual-provider support for both sending and receiving
  - **Receiving**: Webhook at `/inbound` Convex HTTP endpoint handles both Resend and inbound.new formats
    - Webhook authentication via INBOUND_WEBHOOK_SECRET header
    - Rate limiting: 60 req/min per IP
    - Request validation: POST-only, 256KB limit, application/json Content-Type
    - Zod schema validation on all payloads
    - Idempotency: messageId index prevents duplicates
    - Security logging for all violations
  - **Sending**: Tries Resend first (if RESEND_API_KEY set), falls back to inbound.new (if NEXT_INBOUND_API_KEY set)
    - Limits: 100 recipients max, 1MB body, 500 char subject
    - Retry strategy: 3 attempts with 5s/10s/15s backoff
- **Database**: Convex with emails table (from, to, cc, bcc, subject, preview, body, read/starred/archived/trashed/draft status, receivedAt, messageId, threadId, inReplyTo, references, replyTo, rawHeaders, category) and users table for authentication and contacts table (primaryEmail, name, emails, company, title, avatarUrl, notes, tags, lastContactedAt, crmIds, enrichment, customFields, createdAt, updatedAt)
  - Indexes: by_messageId (idempotency), by_threadId (threading), by_receivedAt (chronological ordering), by_read, by_archived, by_trashed, by_draft (query optimization), by_primaryEmail, by_name, by_updatedAt (contacts)
  - Performance: Pagination limits (100 items per query for most queries, 50 items per page for contact email timeline with cursor-based pagination)
- **Routes**: `/` (inbox), `/archive`, `/starred`, `/sent`, `/compose`, `/drafts`, `/trash`, `/signin`, `/contacts`
- **Analytics**: Vercel Analytics for tracking usage
- **Dependencies**: Additional libraries include react-hook-form, zod (for form validation), cmdk (for search/command palette), date-fns (for date handling), lucide-react (for icons), react-resizable-panels (for resizable layouts), recharts (for data visualization), tailwind-merge (for class merging), @tiptap/react, @tiptap/starter-kit (for rich text editing in composer)
- **Layout**: Fixed viewport frame with internal scrolling
  - Root body uses `h-dvh overflow-hidden` to prevent page scroll
  - Each section (sidebar, email list, detail) has sticky headers with internal `overflow-y-auto` content
  - All 4 corners of the frame remain visible at all times
- **Composer**: Unified Composer component handles all email composition with rich text editing using TipTap
  - Supports modes: `inline` (for replies within email detail) and `modal` (for new composition via Dialog)
  - Supports intents: `new`, `reply`, `replyAll`, `forward`
  - Smart sender selection based on original recipient
  - Smooth animations and focus management
  - Auto-save with 800ms debouncing (saves drafts while typing after brief inactivity)
  - Inline reply mode: renders composer directly below messages in thread view (Gmail-style UX)
  - Only one inline composer active at a time, managed via compose provider state
  - Located at `components/composer/composer.tsx`
- **Features**:
  - Email archiving/unarchiving, starring/unstarring, trashing/restoring, multiple view filters
  - HTML email body rendering with centralized DOMPurify sanitization (one-time hook initialization with security guards: protocol allowlist for src/href, tracking pixel removal, iframe restricted to YouTube/Vimeo, enforces rel="noopener noreferrer nofollow" on links for XSS/tabnabbing protection)
  - Dynamic unread email count badge in navigation (live updates)
  - Chronological sorting (most recent emails first)
  - Unified compose/reply/forward experience with modern UX and draft management
  - Reply to emails functionality with pre-filled subject and recipient
  - Reply all to emails functionality with smart sender selection
  - Forward emails functionality with quoted original message
  - Contact management from sent email history (extracts and splits comma-separated recipients from to/cc fields)
  - Contacts management: auto-create contacts from email interactions, manual creation via "New Contact" dialog with email/name/company/title/notes/tags, manual edit with name/company/title/notes/tags, contact list page with search, contact detail view with activity metrics and email history timeline
  - Contact email history timeline: paginated timeline-style list of related email events showing sent/received emails with infinite scroll, grouped by date (Today, Yesterday, chronological), visual indicators for direction, located at `components/contacts/contact-events-timeline.tsx`
  - Dark/light theme toggle
  - Toast notifications for user feedback (success/error messages)
  - Search input placeholder in sidebar (functionality not yet implemented)
  - RFC-compliant email threading with In-Reply-To/References headers
    - Stable threadId computation (References → In-Reply-To → Message-ID → subject fingerprint)
    - Parses threading headers from inbound emails (Message-ID, In-Reply-To, References, Reply-To)
    - Emits In-Reply-To/References headers on replies for cross-client threading
    - UI grouping in detail view with inline reply composers per message
    - by_threadId index for efficient thread queries
    - Backfill mutation available for existing emails
  - Accessibility features:
    - aria-labels on all icon-only buttons for screen reader support
    - TipTap editors have role="textbox", aria-multiline="true", and meaningful aria-label attributes
    - Search input has aria-label for accessibility
    - All form inputs have associated labels
    - Sonner toast notifications with built-in aria-live regions
    - jsx-a11y ESLint rules enabled for ongoing accessibility compliance
  - Composer hidden on signin page for cleaner UX

## Code Style Guidelines
- **TypeScript**: Strict mode enabled with `noImplicitAny` and `noUncheckedIndexedAccess`, target ES2017
- **Type Safety**: Strict TypeScript mode with no `as any` bypasses in production code (one justified exception in convex/emails.ts with eslint-disable comment)
- **Imports**: Use path aliases `@/*` for project root imports
- **Components**: shadcn/ui "new-york" style, RSC compatible, shared components preferred over duplication (refactored email views to use shared `EmailPage`, `EmailList`, and `EmailDetail` components)
- **Styling**: Tailwind CSS with `cn()` utility for conditional classes
- **Linting**: ESLint with Next.js core-web-vitals + TypeScript rules + jsx-a11y for accessibility
- **Naming**: camelCase for variables/functions, PascalCase for components
- **Error Handling**: Standard try/catch, no custom error boundaries yet
- **Architecture**: Single shared components for email views (e.g., `MailSidebar`, `EmailPage`, `EmailList`, `EmailDetail`, `Composer`) over view-specific duplicates; drafts use separate `DraftList` and `DraftDetail` components with full draft management (save, load, delete); contacts use shared `ContactList`, `ContactDetail`, `ContactEventsTimeline`, and `NewContactDialog` components; infinite scroll pagination via reusable `InfiniteScroll` component using Intersection Observer API

## Security Hardening
- **Next.js Security Headers** (next.config.ts): X-Frame-Options: DENY, X-Content-Type-Options: nosniff, Referrer-Policy: strict-origin-when-cross-origin, Permissions-Policy restrictions, CSP and HSTS configured
- **Webhook Authentication**: INBOUND_WEBHOOK_SECRET header validation (401 on missing/invalid signature)
- **Webhook Rate Limiting**: 60 requests/minute per IP address with automatic cleanup (429 on exceeded)
- **Request Validation**: Zod schema validation on all server entry points (webhooks, mutations, actions)
- **HTML Sanitization**: Centralized DOMPurify with one-time hook initialization blocks XSS vectors (no style tags, protocol allowlist for src/href, tracking pixel removal, iframe restricted to YouTube/Vimeo, enforced rel attributes on links)
- **Webhook Idempotency**: messageId index prevents duplicate email creation from repeated webhook calls
- **Server-Side Auth**: All restrictions enforced server-side via Convex callbacks (cannot be bypassed client-side)
- **Type Safety**: Strict TypeScript mode with `noImplicitAny` and `noUncheckedIndexedAccess` enabled
- **Security Logging**: Centralized structured logging for auth failures, webhook violations, suspicious activity (7-day retention with auto-cleanup)
- **Request Limits** (convex/http.ts, convex/emails.ts):
  - Webhook: 256KB payload limit, 60 req/min per IP, POST-only
  - Email sending: 100 recipients max, 1MB body limit, 500 char subject limit
  - Draft saving: 1MB body limit, 500 char subject limit
  - Retry strategy: 3 attempts max with 5s/10s/15s backoff
  - See REQUEST_LIMITS_SUMMARY.md for full details and adjustment instructions

## Documentation (Wave 2 Complete)
- **README.md**: Comprehensive setup guide with Quick Start for self-hosters (updated for Next.js 16)
- **.env.example**: All environment variables documented with clear comments
- **docs/TESTING.md**: Manual test plan with 10 test scenarios (happy path, negative tests, edge cases)
- **docs/SECURITY.md**: Security best practices, threat model, hardening checklist, security logging strategy
- **docs/AUTH_CONTRACT.md**: Auth implementation contract from Wave 0/1
- **docs/WEBHOOK_SECURITY.md**: Webhook security implementation and setup guide
- **docs/ACCESSIBILITY.md**: Accessibility features and WCAG compliance documentation
- **docs/VALIDATION.md**: Zod schema validation documentation
- **docs/DEDUPLICATION_SUMMARY.md**: Code deduplication effort summary
- **CODE_CLEANUP.md**: Comprehensive code review findings and cleanup tasks
- **SPRINT_SUMMARY.md**: Security hardening sprint completion summary (Nov 2025)
- **WEBHOOK_SECURITY_SUMMARY.md**: Webhook security implementation details
- **SECURITY_LOGGING_SUMMARY.md**: Centralized logging implementation
- **TYPESCRIPT_STRICTNESS_IMPROVEMENTS.md**: TypeScript strict mode migration
- **REQUEST_LIMITS_SUMMARY.md**: Request size/time limits documentation

## Next.js 16 Migration Notes
- Migrated from Next.js 15.5.4 to 16.0.1 (December 2024)
- **proxy.ts**: Replaced `middleware.ts` with `proxy.ts` per Next.js 16 convention (functionality unchanged, Convex Auth compatibility verified)
- **Turbopack**: Now default bundler (no config needed, faster builds)
- **React Types**: Removed `@types/react` and `@types/react-dom` devDependencies (React 19 includes types)
- **No Async API Changes**: All components are client-side, no migration needed for cookies/headers/draftMode/params/searchParams
- **Build Verification**: Production build succeeds, all routes compile correctly
- **Cache Components**: Not applicable (app uses client components with Convex hooks; Cache Components are for server components)